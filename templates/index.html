<!DOCTYPE html>
<html lang="en">

        
<head>
    <meta charset="UTF-8">
    <link rel="icon" href = "/static/mbta.png" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
            integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
            crossorigin=""
            />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin="">
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/static/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
    <link rel = "stylesheet" href = "/static/Leaflet.markercluster-1.4.1/Leaflet.markercluster-1.4.1/dist/MarkerCluster.css"/>
    <link rel = "stylesheet" href = "/static/Leaflet.markercluster-1.4.1/Leaflet.markercluster-1.4.1/dist/MarkerCluster.Default.css"/>
    <script src = "/static/Leaflet.markercluster-1.4.1/Leaflet.markercluster-1.4.1/dist/leaflet.markercluster-src.js"></script>
    <script src = "/static/Leaflet.markercluster-1.4.1/Leaflet.markercluster-1.4.1/src/MarkerClusterGroup.js"></script>

    <link rel = "stylesheet" href = "/static/custom_css/popup.css"/>
    
    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
    <style>.leaflet-popup-content-wrapper, .leaflet-popup-tip { 
        background: rgb(0, 0, 0, 0.95) !important;
        color: #ffffff !important;
        font-family: 'montserrat', sans-serif !important;
        font-size: 10pt !important;
        text-align: left !important;
        maxWidth: "auto" !important;        
    } </style>
    
    <title>MBTA System Map</title>
</head>
<body>
    <div id="map"></div>
    <script>

        let route_type = 2;
        var map = L.map('map').setView([42.3519, -71.0552], 13);
        
        var CartoDB_DarkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        var CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        });

        var Stadia_AlidadeSmoothDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        });

        // Create a layer group for the vehicles

        var stop_layer = L.layerGroup()
        var shape_layer = L.layerGroup().addTo(map);
        var bus_replacement_layer = L.layerGroup().addTo(map);
        var vehicle_layer = L.markerClusterGroup().addTo(map);

        var overlays = {
            "Vehicles": vehicle_layer,
            "Stops": stop_layer,
            "Shapes": shape_layer,

        };

        var baseMaps = {
            "Dark": CartoDB_DarkMatter,
            "Light": CartoDB_Positron,
            "Alt Dark": Stadia_AlidadeSmoothDark,
        };

        if (route_type !=3){
            stop_layer.addTo(map);
            overlays["Bus Replacement"] = bus_replacement_layer;
        } 

        var layerControl = L.control.layers(baseMaps, overlays).addTo(map);
        
        plotShapes(route_type);
        plotStops(route_type);
        plotVehicles(route_type);


        // calls function every 15 seconds
        var intervalId = window.setInterval(function () {
            plotVehicles(route_type);
        }, 15000);


        function plotVehicles(route_type=route_type) {


            var vehicle_icon = L.icon({
                iconUrl: '/static/icon.png',
                iconSize: [40, 40],
            });


            $.getJSON("/vehicles/" + route_type, function(vehicle_dict) {
                console.log(vehicle_dict);
                vehicle_layer.clearLayers();
                for (var i = 0; i < vehicle_dict.length; i++) {
                    const vehicle = vehicle_dict[i];

                    if(vehicle.direction_id == 0) {
                        direction = "Outbound";
                    } else {
                        direction = "Inbound";
                    }
                    if (route_type != 3) {
                        var vehicle_type = "Train"
                        var control = "Control"
                    } else{
                        var vehicle_type = "Bus"
                        var control = "Bus ID"
                    }

                    if (vehicle.bikes_allowed == 1) {
                        var bike = `<a class = "tooltip"><img src ="static/bike.png" alt = "bikes allowed" width=25 height=25 style="margin:2px;">
                            <span class = "tooltiptext">text</span></a>`
                    } else {
                        var bike = ""
                    }

                    if (vehicle.alert != "unknown"){
                        var alert = `<img src ="static/alert.png" alt = "alert" width=25 height=25 style="margin:2px;">`
                    } else {
                        var alert = ""
                    }

                    var prediction = `<img src ="static/train_icon.png" alt = "alert" width=25 height=25 style="margin:2px;">`

                    var marker = L.marker([
                        vehicle.latitude, 
                        vehicle.longitude], {
                            icon: vehicle_icon, 
                            rotationAngle: vehicle.bearing,
                            rotationOrigin: 'center',
                    }).setZIndexOffset(100);

                    var popup = marker.bindPopup(
                        `<a href = https://www.mbta.com/schedules/${vehicle.route_id} style="color:#${vehicle.route_color};font-size:28pt;text-decoration: none;text-align: left">`+ 
                        vehicle_type + " " + vehicle.trip_short_name  + "</a></br>" +
                        `<body style="color:#ffffff;text-align: left;">` + 
                        direction + " to " + vehicle.headsign + "</body>" +  "</br>" + 
                        "—————————————————————————————————" + "</br>" +
                        alert + " " + prediction +" " + bike + "</br>" +
                        control + " " + vehicle.vehicle_id + " " +  vehicle.stop_status + " " + vehicle.stop_name + "</br>" +
                        "Speed: " + vehicle.speed + " mph" + "</br>" +
                        "Bearing: " + vehicle.bearing + "°" + "</br>" +
                        `<a style="color:grey;font-size:9pt">` + 
                        "Timestamp: " + vehicle.timestamp + "</br>" +
                        "Route: " + vehicle.route_name + " (" + vehicle.route_id + ") " + "</br>" + 
                        "Trip: " + vehicle.trip_id + "</a>" + 
                        "</body>", 
                        {maxWidth: "auto"}
                    );
                    var tooltip = marker.bindTooltip(vehicle.vehicle_id); 
                    marker.addTo(vehicle_layer);
                }
            });
        }

        function plotStops(route_type=route_type) {

            stop_layer.clearLayers();

            var stop_icon = L.icon({
                iconUrl: '/static/mbta.png',
                iconSize: [15, 15],
            });
            
            $.getJSON("/stops/" + route_type, function(stops_dict) {
                console.log(stops_dict);
                for (var i = 0; i < stops_dict.length; i++) {

                    const stop = stops_dict[i];

                    if (stop.line_serviced == "Commuter Rail") {
                        var route_color = "80276C";
                    } else if (stop.line_serviced == "Green Line") {
                        var route_color = "00843D";
                    } else if (stop.line_serviced == "Orange Line") {
                        var route_color = "ED8B00";
                    } else if (["Red Line", "Mattapan Trolley"].includes(stop.line_serviced)) {
                        var route_color = "DA291C";
                    } else if (stop.line_serviced == "Blue Line") {
                        var route_color = "003DA5";
                    } else if (stop.line_serviced == "Silver Line") {
                        var route_color = "7C878E";
                    } else if (stop.line_serviced.slice(-5) === "Ferry") {
                        var route_color = "008EAA";
                    } else {
                        var route_color = "FFC72C";
                    }

                    if (stop.line_serviced == "unknown"){
                        stop.line_serviced = stop.zone;
                    }


                    var marker = L.marker([stop.latitude, stop.longitude], {icon: stop_icon}).setZIndexOffset(-100);

                    var popup = marker.bindPopup(
                        `<a href = https://www.mbta.com/stops/${stop.stop_id} style="color:#${route_color};font-size:28pt;text-decoration: none;text-align: left">`+ stop.stop_name + "</a></br>" +
                        `<body style="color:#ffffff;text-align: left;">` + stop.line_serviced + "</br>" + 
                        "</body>", 
                        {maxWidth: "auto"}
                        );
                    var tooltip = marker.bindTooltip(stop.stop_name);

                    marker.addTo(stop_layer);
                }
            });
        }

        function plotShapes(route_type=route_type){

            shape_layer.clearLayers();
            bus_replacement_layer.clearLayers();

            $.getJSON("/shapes/" + route_type, function(shapes_dict) {
                console.log(shapes_dict);
                for (var i = 0; i < shapes_dict.length; i++) {

                    const shape = shapes_dict[i];

                    var color = "#" + shape.route_color;
                    var opacity = 0.9;
                    var weight = 0.8;
                    if (shape.parent_route_type != shape.route_type | shape.description == "Local Bus"){
                        opacity = 0.5;
                    } else if (shape.description == "Community Bus"){
                        opacity = 0.35;
                    }
                    if (shape.description == "unknown"){
                        shape.description = "Bus Replacement"
                    }

                    var route = L.polyline(shape.polyline, {color: color, opacity: opacity, weight: weight});
                    var popup = route.bindPopup(
                        `<a href = https://www.mbta.com/schedules/${shape.route_id} style="color:${color};font-size:28pt;text-decoration: none;text-align: left">`+ shape.route_name + "</a></br>" +
                        `<body style="color:#ffffff;text-align: left;">` + shape.description + "</br> </body>", 
                        {maxWidth: "auto"}
                    );
                    var tooltip = route.bindTooltip(shape.route_id);

                    if (shape.parent_route_type != shape.route_type)
                        route.addTo(bus_replacement_layer);
                    else
                        route.addTo(shape_layer);

                }
            });
        }
        </script>

</body>

</html>